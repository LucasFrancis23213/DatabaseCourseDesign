# 4.26用户部分设计更新

by ZYN DPY YXH

## 用户注册

### 1.前端元素

* 登录界面，包括
  1. 用户名
  2. 密码
  3. 验证码（？）
* 注册界面，包括
  1. 自定义用户名
  2. 自定义密码栏
  3. 确认密码栏
  4. 实名认证栏
* 认证界面，包括
  1. 姓名
  2. 身份证号
* 注销界面，包括
  1. 用户名
  2. 密码
  3. 确认注销按钮
  4. 确认注销信息提示
* 关联界面
  1. VIP界面
  2. 个人信息界面，包括
     1. 头像（？）
     2. 用户名
     3. 用户ID
     4. VIP等级信息
     5. 是否实名认证

### 2.流程图

在表AuthInfo中补充了与表VIPMembers关联的元素：VIPLevel和Status

![用户注册](.\用户注册.jpg)



### 3.新出现的问题

* 若只有实名认证一种认证方式，是否保留AuthMethod？
* 删除AuthID后AuthInfo没有PK
* 登录界面是否需要验证码？
* 个人主页是否需要显示头像？（若添加可能需要加上更多表或元素）



## 用户管理

### 说明

#### 流程图

这部分都是触发机制或定期执行的，无流程图。使用可能关联的表代替。

在这部分同时完成前端需要元素及相关触发机制的说明。

***

待定：触发方式选择：前端？修改表后的 trigger ？

- **前端**
  - 优点：
    - 较为灵活（带来操作不规范的问题）
    - 不受表的限制
    - 可以完成所有的内容

  - 缺点：
    - 如何实现原子级操作？
    - 如何实现数据库的同步？
  
- trigger
  - 优点：
    - 容易实现原子级操作
    - 保证数据库的同步

  - 缺点：
    - 对 trigger 的使用不熟练
    - 有些内容可能无法由 trigger 实现（也可能是没有了解高级功能）
    - 受限于表的修改查询等，不灵活
    - 需要良好设计，有的操作可能设计多个表的更改，但是只应该记录一次

性能问题完全不了解

#### 1. NotificationLogs

发送通知可以由 table 的修改表示，但是如何用 table 表示用户点开通知？

触发机制：系统发送通知、用户点击或关闭通知

1. 发送通知（需要提供 通知ID（自己生成？不建议），用户ID，通知类型，发送时间）
2. 用户对通知操作（需要提供 通知ID， 用户ID）

#### 2. UserActivityLogs

有些内容只能由前端完成，例如用户登录。有些内容可以由数据库更改触发，关联的表如下：

AuthInfo  UserPreferences  UserRatings  (UserPoints)  UserMessages  UserRelationships

UserSubscriptions  LostItems  FoundItems  ItemComments  ItemClaimProcesses

UserFeedback  RewardOffers  ItemExchanges  ItemReturnAgreements  

SocialMediaShares  UserFeeds  QnA  FollowLists  

触发机制：用户所有操作成功(如何判断成功？)

需要信息：（理想为前端每个按钮都绑定一条信息，作为`行为类型`），发生时间，用户ID，（行为ID）

#### 3. DataAnalysisReports

定期生成？用户点击时生成？
需要访问UserActivityLogs

#### 4. RecommendationLogs

与通知相同

#### 5. TransactionLogs

建议由审核人员审核后触发

需要信息：所有信息

另外建议：只记录完成的交易，建新表记录未完成交易？

### 具体表设计

- 通知记录表 (NotificationLogs)
  - **通知ID** (NotificationID): 唯一标识每个通知的主键。
  - **用户ID** (UserID): 要通知的用户ID，外键，关联到Users表的UserID。
  - **通知类型** (NotificationType): 通知的类型，如“物品匹配通知”、“系统通知”等。
  - **发送日期** (SentDate): 通知发送的日期和时间。
  - **状态** (Status): 通知的状态，如已读、未读。

- 用户行为日志表 (UserActivityLogs)：通过记录用户的每一次活动，帮助管理员更好地理解用户行为，优化用户体验。
  - **行为日志ID** (ActivityLogID): 唯一标识每条用户行为记录的主键。
  - **用户ID** (UserID): 行为发起者的用户ID，外键，关联到Users表的UserID。
  - **行为类型** (ActivityType): 用户行为的类型，如“登录”、“发布物品”、“评论”等。
  ~~- **行为详情** (ActivityDetails): 行为的详细描述。~~（拟弃用，4.26日）
  - **发生时间** (Timestamp): 行为发生的具体时间。

- 数据分析报表 (DataAnalysisReports)：定期生成各种数据分析报表，帮助管理员了解平台运营状况，指导决策。
  - **报表ID** (ReportID): 唯一标识每个报表记录的主键。
  - **用户ID** (UserID): 报表对应的用户。(拟更改，4.26日，添加用户ID)
  - **报表类型** (ReportType): 报表的类型，如“用户活跃度分析”、“物品找回率统计”等。
  - **报表数据** (ReportData): 报表的具体数据内容，可能包含文字、数字或图表等。
  - **生成日期** (GenerationDate): 报表生成的日期。

- 推荐系统日志表 (RecommendationLogs)
  - **日志ID** (LogID): 唯一标识每条推荐日志记录的主键。
  - **用户ID** (UserID): 接受推荐的用户ID，外键，关联到Users表的UserID。
  - **推荐类别** (RecommendedContent): 推荐的类型。(拟更改，4.26日，改为推荐类别)
  - **推荐时间** (RecommendationTime): 推荐发生的时间。
  - **用户反馈** (UserFeedback): 用户对推荐内容的反馈，如“有用”、“无用”。
  
- 交易记录表 (TransactionLogs)
  - **TransactionID** (交易ID): 主键，唯一标识每笔交易。
  - **FromUserID** (发起方用户ID): 发起交易的用户ID，外键，关联到**Users**表。
  - **ToUserID** (接收方用户ID): 接收交易的用户ID（如果适用），外键，关联到**Users**表。对于系统收费等情况，此字段可能为空或指向一个特定的系统账户。
  - **ItemID** (物品ID): 交易相关的物品ID（如果适用），外键，关联到**LostItems**或**FoundItems**表。不是所有交易都与物品直接相关，因此，这个字段在某些记录中可能为空。
  - **Amount** (金额): 交易金额。（拟更改，4.26日，取消负数）
  - **TransactionType** (交易类型): 描述交易类型的字符串，如"赏金支付"、"服务购买"、"退款"等。
  - **Status** (状态): 交易的当前状态，如"进行中"、"完成"、"失败"等。
  ~~- **TransactionDate** (交易日期): 记录交易发生的日期和时间。~~(拟弃用，4.26日)
  - **TransactionBeginDate** (交易开始日期): 记录交易开始的时间(交易发起，类比淘宝用户付完钱等待收货的状态)。(拟更改，4.26日，改为开始和完成时间)
  - **TransactionEndDate** (交易完成日期): 记录交易完成的时间(交易结束，可能是用户点击确认收获后对应的记录)。(拟更改，4.26日)
  - **Description** (描述): 关于交易的额外信息或备注，例如交易的具体目的或原因。

### 新问题

1. 各个Log的ID如何获取？如果将来查询时无法通过此ID获取信息，此条目作用？
2. 每个交易都会被 UserActivityLogs 和 TransactionLogs 记录，它们之间的 ID 关联？此时 UserActivityLogs 的时间如何记录？或者将其拆分成多个行为？
3. 重复问题？例如2和推荐与通知



# 网站维护方面设计

## 前端需求
### 用户界面设计与用户体验
- 设计一个直观且响应式的用户界面，确保在不同设备上均有良好展示。
- 使用清晰的导航和布局，方便管理员快速找到所需功能。
- 设计动态数据更新功能，使得管理员能够实时看到最新的数据和状态更新。

### 系统日志管理界面
- 实现一个日志查看页面，能够展示系统日志的详细信息。
- 提供搜索和过滤功能，帮助管理员快速定位特定日志。
- 添加功能以便管理员能够删除旧日志，释放存储空间。

### API 管理界面
- 创建一个页面用于显示API访问日志，包括调用时间、状态码和API路径。
- 实现API调用失败次数的统计图表，帮助管理员分析API的健康状况。

### 任务管理界面
- 制作一个任务状态查看页面，列出所有定时任务及其当前状态。
- 提供界面让管理员能夜更新或修改任务状态，如启动、停止或重置定时任务。

### 安全事件管理界面
- 开发一个安全事件页面，显示所有未处理和正在处理的安全事件。
- 实现功能以让管理员更新事件状态，例如标记为已解决或重要性级别的调整。

### 环境搭建与配置
- 配置开发环境，确保前端开发工具和库（如 Vue.js）的正确安装和配置。
- 使用前后端分离的开发模式，确保API的可测试性和可维护性。

***
## 需要的表(宽泛功能介绍，不影响总表)
### SystemLogs(系统日志表)  
>日志ID (LogID): 唯一标识每条系统日志的主键。  
操作类型 (OperationType): 发生的操作类型，如系统维护、数据备份、异常报告等。  
操作详情 (OperationDetails): 操作的具体详情。  
操作用户ID (UserID): 执行操作的用户ID，可以为空，外键，关联到Users表的UserID。  
操作日期 (OperationDate): 操作发生的日期和时间。  
### APIAccessLogs(API访问日志表)  
>访问ID (AccessID): 唯一标识每次API访问的主键。  
API名称 (APIName): 被访问的API名称或标识。  
访问者标识 (AccessorID): 访问者的标识，可能是用户ID或第三方应用ID。  
访问时间 (AccessTime): API被访问的时间。   
访问结果 (AccessResult): API访问的结果，如“成功”、“失败”、“错误代码”。  
### ScheduledTasks(定时任务表)  
>任务ID (TaskID): 唯一标识每个定时任务的主键。  
任务类型 (TaskType): 定时任务的类型，如“数据备份”、“报表生成”等。  
任务状态 (TaskStatus): 任务的执行状态，如“待执行”、“执行中”、“已完成”等。  
执行时间 (ExecutionTime): 定时任务执行的时间点。  
任务详情 (TaskDetails): 任务的详细描述或执行参数。  
### SecurityEvents(安全事件记录表)  
>事件ID (EventID): 唯一标识每个安全事件的主键。  
事件类型 (EventType): 安全事件的类型，如“账户异常登录”、“数据泄露”等。  
事件详情 (EventDetails): 事件的详细信息。  
处理状态 (Status): 事件的处理状态，如“已解决”、“待处理”等。  
发生日期 (OccurrenceDate): 事件发生的日期。  
>
上述表是宽泛设计的表示例，具体功能在4.18有相关介绍   
***
## 新增的具体表
对于陆诚彬同学组反馈的问题的安全事件记录表如下：    
问题：  
>*由于目前审核系统的设计，并不设计单独的审核表，故用户将拥有直接对大表（遗失物品表、找回物品表）的读写权限，建议在用户发布物品时，使用预编译语句（下拉框）等方式防止SQL注入的风险；或者设计一个过渡表（？），在验证用户填写的信息是安全的（指不会引发sql风险）的情况后，再往大表中写*   
>  
可能需要调用的表：  
>遗失物品表 (LostItems)  
找回物品表 (FoundItems)  
物品图片表 (ItemImages)  
物品-标签关联表 (ItemTagLinks)  
物品标签表 (ItemTags)  
赏金悬赏表 (RewardOffers)  
用户偏好设计表 (UserPreferences)  
用户订阅表 (UserSubscriptions)  
【新增】审核状态码表 (ReviewCodes)  
>【新增】物品审核状态关联表 (ItemReviewLinks)   
>

由此设计的相关过渡表如下：  

### 1. 过渡表的设计 (TransitionTable)

**结构说明：**
- **TempItemID**: 临时ID，主键，系统自动生成。
- **ItemID**: 关联的正式物品ID，为空表示新提交的物品。
- **ItemName**: 物品名称，用户输入。
- **CategoryID**: 类别ID，用户选择，关联到ItemCategories表。
- **Description**: 描述，用户输入。
- **Location**: 地点（遗失地点或找回地点），用户输入。
- **Date**: 日期（遗失日期或找回日期），用户输入。
- **UserID**: 用户ID，提交信息的用户，关联到Users表。
- **ImageURL**: 图片URL，用户上传。
- **Status**: 物品的审核状态，如“待审核”、“审核通过”、“审核拒绝”等。
- **ProcessType**: 处理类型，标识是“遗失物品”还是“找回物品”。
- **SubmissionDate**: 提交日期，系统自动生成。
- **ReviewComments**: 审核备注，用于记录审核过程中的任何特别说明或问题。

### 2. 数据验证与审核流程

**流程说明：**
1. **用户提交**: 用户填写表单并提交数据，数据首先写入`TransitionTable`。
2. **数据验证**:
   - 自动验证: 系统自动进行基本的数据验证，如字段格式（日期格式、文本长度等）、SQL注入风险等。
   - 人工审核: 需要审核员对提交的数据进行审核，确认信息的合理性和准确性。
3. **审核通过**:
   - 如果是新的物品信息，生成新的正式ID，并将数据从`TransitionTable`迁移到相应的正式表（如`LostItems`或`FoundItems`）。
   - 如果是修改现有物品的信息，直接在正式表中更新相应记录。
4. **审核拒绝**: 在`TransitionTable`中更新状态为“审核拒绝”，并记录拒绝原因，用户可以查看反馈并重新提交。

### 3. 审核状态码表 (ReviewCodes) 的集成

在`TransitionTable`中引用`ReviewCodes`表，通过`ReviewID`字段将每条记录与审核状态关联起来，便于管理和跟踪审核结果。    

### 4. 触发条件  
>为了确保数据的完整性和安全性，我们可以为过渡表（TransitionTable）设计一系列的触发条件。以下是一些基本的触发条件示例，这些条件将在数据库层面自动执行，以保证数据处理流程的正确性和安全性。

>### 1. 插入前验证 (BEFORE INSERT Trigger)
>在数据被插入过渡表之前，触发此条件来验证数据的有效性，包括：
>- 检查必填字段是否为空，如`ItemName`, `CategoryID`, `Description`, `Location`, `Date`, `UserID`。
>- 验证日期格式是否正确。
>- 检查字符串字段长度是否符合要求。
>- 验证`UserID`是否存在于用户表（Users）中。

>### 2. 插入后处理 (AFTER INSERT Trigger)
>数据插入过渡表后，自动进行以下操作：
>- 自动生成`TempItemID`。
>- 记录数据的提交时间（`SubmissionDate`）。
>- 初始设置审核状态为“待审核”(`ReviewID = 00`)。

>### 3. 更新前验证 (BEFORE UPDATE Trigger)
>在更新过渡表中的数据之前，触发此条件来验证更改的合理性：
>- 如果尝试修改`TempItemID`或`SubmissionDate`，则阻止修改。
>- 检查修改的字段是否满足数据类型和长度要求。
>- 当状态更新为“审核通过”时，检查所有必要信息是否完整。

>### 4. 更新后处理 (AFTER UPDATE Trigger)
>当审核状态发生变化时，根据审核结果进行后续处理：
>- 如果审核状态更新为“审核通过”，根据`ProcessType`将数据迁移到相应的正式表（如`LostItems`或`FoundItems`），并在过渡表中标记该条目为已处理。
>- 如果状态为“审核拒绝”，记录拒绝原因（`ReviewComments`）以供用户查询。
